-- ====== ESP AYARLARI ======
local FillColor = Color3.fromRGB(175,25,255)
local DepthMode = "AlwaysOnTop"
local FillTransparency = 0.5
local OutlineColor = Color3.fromRGB(255,255,255)
local OutlineTransparency = 0

-- ====== SERVİSLER ======
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")
local lp = Players.LocalPlayer

-- ====== ESP STORAGE ======
local Storage = Instance.new("Folder")
Storage.Name = "Highlight_Storage"
Storage.Parent = CoreGui

local connections = {}
local espEnabled = false

-- ====== ESP FONKSİYONLARI ======
local function Highlight(plr)
	if not espEnabled then return end
	if Storage:FindFirstChild(plr.Name) then return end

	local h = Instance.new("Highlight")
	h.Name = plr.Name
	h.FillColor = FillColor
	h.DepthMode = DepthMode
	h.FillTransparency = FillTransparency
	h.OutlineColor = OutlineColor
	h.OutlineTransparency = OutlineTransparency
	h.Parent = Storage

	if plr.Character then
		h.Adornee = plr.Character
	end

	connections[plr] = plr.CharacterAdded:Connect(function(char)
		if espEnabled then
			h.Adornee = char
		end
	end)
end

local function EnableESP()
	espEnabled = true
	for _, plr in pairs(Players:GetPlayers()) do
		if plr ~= lp then
			Highlight(plr)
		end
	end
end

local function DisableESP()
	espEnabled = false
	Storage:ClearAllChildren()

	for _, c in pairs(connections) do
		c:Disconnect()
	end
	table.clear(connections)
end

Players.PlayerAdded:Connect(function(plr)
	if espEnabled then
		Highlight(plr)
	end
end)

Players.PlayerRemoving:Connect(function(plr)
	if Storage:FindFirstChild(plr.Name) then
		Storage[plr.Name]:Destroy()
	end
	if connections[plr] then
		connections[plr]:Disconnect()
	end
end)

-- ====== GUI ======
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ESP_GUI"
ScreenGui.Parent = CoreGui

local Frame = Instance.new("Frame")
Frame.Parent = ScreenGui
Frame.Size = UDim2.new(0, 220, 0, 120)
Frame.Position = UDim2.new(0.5, -110, 0.5, -60)
Frame.BackgroundColor3 = Color3.fromRGB(30,30,30)
Frame.BorderSizePixel = 0
Frame.Active = true

local UICorner = Instance.new("UICorner", Frame)
UICorner.CornerRadius = UDim.new(0, 8)

local StatusLabel = Instance.new("TextLabel")
StatusLabel.Parent = Frame
StatusLabel.Size = UDim2.new(1, 0, 0, 40)
StatusLabel.Position = UDim2.new(0, 0, 0, 10)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "ESP : CLOSED"
StatusLabel.TextColor3 = Color3.fromRGB(255,80,80)
StatusLabel.Font = Enum.Font.GothamBold
StatusLabel.TextSize = 18

local ToggleButton = Instance.new("TextButton")
ToggleButton.Parent = Frame
ToggleButton.Size = UDim2.new(0.8, 0, 0, 35)
ToggleButton.Position = UDim2.new(0.1, 0, 0.55, 0)
ToggleButton.BackgroundColor3 = Color3.fromRGB(60,60,60)
ToggleButton.Text = "TOGGLE"
ToggleButton.TextColor3 = Color3.fromRGB(255,255,255)
ToggleButton.Font = Enum.Font.Gotham
ToggleButton.TextSize = 16
ToggleButton.BorderSizePixel = 0

local btnCorner = Instance.new("UICorner", ToggleButton)
btnCorner.CornerRadius = UDim.new(0, 6)

-- ====== BUTON ======
ToggleButton.MouseButton1Click:Connect(function()
	if espEnabled then
		DisableESP()
		StatusLabel.Text = "ESP : CLOSED"
		StatusLabel.TextColor3 = Color3.fromRGB(255,80,80)
	else
		EnableESP()
		StatusLabel.Text = "ESP : OPEN"
		StatusLabel.TextColor3 = Color3.fromRGB(80,255,80)
	end
end)

-- ====== SÜRÜKLEME SİSTEMİ ======
local dragging = false
local dragStart
local startPos

Frame.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = true
		dragStart = input.Position
		startPos = Frame.Position
	end
end)

Frame.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 then
		dragging = false
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
		local delta = input.Position - dragStart
		Frame.Position = UDim2.new(
			startPos.X.Scale,
			startPos.X.Offset + delta.X,
			startPos.Y.Scale,
			startPos.Y.Offset + delta.Y
		)
	end
end)
